# Abyss Farmer - New Room Implementation

## Описание

Новая реализация прохождения комнат в Абиссе с улучшенной логикой и надежностью.

## Файлы

- `room_new.py` - новая реализация прохождения комнаты
- `room.py` - старая реализация (для справки)

## Функция default_room()

Проходит стандартную комнату в Абиссе по следующему алгоритму:

### Пайплайн

1. **Переключение на вкладку Main**
   - Переключается на вкладку "Main" в overview

2. **Проверка мид слотов**
   - Проверяет что оба активных модуля в средних слотах включены

3. **Ожидание контейнера**
   - Ждет появления Triglavian Bioadaptive Cache в overview

4. **Орбита контейнера**
   - Кликает на контейнер
   - Ждет появления кнопки "orbit"
   - Выходит на орбиту

5. **Выпуск дронов**
   - Выпускает дронов (Shift+F)

6. **Переключение на PvP Foe**
   - Переключается на вкладку "PvP Foe"
   - Ждет появления целей

7. **Убийство первой цели**
   - Ждет пока любая цель не окажется на расстоянии <= 35км
   - Лочит цель (Ctrl+Click)
   - Убивает (1 + F)
   - Ждет смерти цели

8. **Уничтожение контейнера**
   - Переключается на Main
   - Ждет появления контейнера в overview
   - Лочит контейнер
   - Ждет пока ракеты станут inactive
   - Активирует ракеты (1)
   - Ждет смерти контейнера

9. **Лут контейнера**
   - Ждет появления врека
   - Кликает по вреку
   - Выбирает approach
   - Открывает карго врека
   - Ждет кнопки "Взять все"
   - Забирает лут

10. **Орбита гейта**
    - Находит Acceleration Gate
    - Выходит на орбиту

11. **Переключение на PvP Foe**
    - Переключается на вкладку "PvP Foe" через 0.3с

12. **Зачистка врагов**
    - Убивает все цели в PvP Foe волнами
    - Лочит до 5 целей за раз
    - Убивает каждую (1 + F)
    - Повторяет пока overview не пустой

## Использование

```python
from core.sanderling.service import SanderlingService
from bots.abyss_farmer.room_new import default_room

sanderling = SanderlingService()
sanderling.start()

# Пройти комнату
success = default_room(sanderling, timeout=300.0)

if success:
    print("Комната пройдена!")
else:
    print("Ошибка прохождения комнаты")
```

## Тестирование

Запустить тест:

```bash
python scripts/test_default_room.py
```

## Требования

- Sanderling должен быть запущен и подключен к игре
- Корабль должен находиться в комнате Абисса
- Настроены хоткеи:
  - `1` - ракеты (верхний слот)
  - `2` - МВД (средний слот, левый)
  - `3` - второй мид слот (правый)
  - `Shift+F` - выпуск дронов
  - `F` - атака дронами
- Настроены вкладки overview:
  - Вкладка с названием содержащим "Main" (или используйте DefaultPreset)
  - Вкладка с названием содержащим "PvP Foe" (для врагов)
  
**Примечание:** Функция ищет вкладки по частичному совпадению, игнорируя HTML теги и спецсимволы.
Например, вкладка `<color=red>✥ PvP Foe</color>` будет найдена по запросу "PvP Foe".

## Отличия от старой реализации

1. **Более детальный пайплайн** - каждый шаг четко определен
2. **Лучшая обработка ошибок** - больше проверок и логирования
3. **Правильная последовательность** - сначала убиваем первую цель, потом контейнер
4. **Орбита вместо аппроча** - используем orbit для контейнера и гейта
5. **Проверка inactive ракет** - перед стрельбой по контейнеру
6. **Волновая зачистка** - убиваем врагов пачками по 5

## TODO

- [ ] Добавить определение типа комнаты
- [ ] Реализовать специальные комнаты (с особыми врагами)
- [ ] Добавить обработку ошибок и retry логику
- [ ] Оптимизировать таймауты
- [ ] Добавить телеметрию и статистику
