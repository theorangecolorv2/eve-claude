# Документ требований

## Введение

Проект EVE Online бота требует реорганизации структуры для улучшения поддерживаемости и масштабируемости. Текущая структура имеет беспорядок в организации файлов - логи, дебаг файлы, JSON данные и временные файлы разбросаны по корневой директории. Кроме того, модуль чтения памяти Sanderling требует доработки для обеспечения стабильной, быстрой и автоматизированной работы.

Проект представляет собой систему автоматизации для игры EVE Online, написанную на Python, которая использует:
- Sanderling (C# компонент) для чтения памяти игры
- CV инструменты для компьютерного зрения (template matching)
- Готовый бот для фарма аномалий
- Планируемый бот для фарма абиссов

## Глоссарий

- **Система** - EVE Online бот и все его компоненты
- **Sanderling** - Модуль чтения памяти EVE Online (C# библиотека)
- **CV_Инструменты** - Модули компьютерного зрения для template matching
- **Бот** - Автономный скрипт для выполнения игровых задач
- **UI_Tree** - Дерево элементов пользовательского интерфейса EVE Online
- **Root_Address** - Адрес корневого элемента UI tree в памяти
- **Template_Matching** - Метод поиска изображений на экране
- **Аномалия** - Игровая локация для фарма (убежище/укрытие)
- **Абисс** - Специальный тип игровой локации

## Требования

### Требование 1: Реорганизация структуры проекта

**User Story:** Как разработчик, я хочу иметь четкую иерархию папок, чтобы легко находить нужные компоненты и поддерживать проект.

#### Критерии приемки

1. THE Система SHALL организовать код в следующую структуру директорий:
   - `core/sanderling/` - модуль чтения памяти
   - `core/cv/` - инструменты компьютерного зрения
   - `bots/anomaly_farmer/` - бот для фарма аномалий
   - `bots/abyss_farmer/` - бот для фарма абиссов (заготовка)
   - `shared/` - общие утилиты для всех ботов

2. THE Система SHALL изолировать временные и служебные файлы:
   - `output/logs/` - все лог файлы
   - `output/debug/` - дебаг скриншоты и данные
   - `output/data/` - JSON данные и статистика
   - `output/temp/` - временные файлы

3. THE Система SHALL сохранить исходники и бинарные файлы Sanderling:
   - `external/Sanderling/` - исходный код C#
   - `external/sanderling-bin/` - скомпилированные бинарники

4. THE Система SHALL организовать ресурсы и конфигурацию:
   - `resources/assets/` - изображения для template matching
   - `resources/config/` - конфигурационные файлы
   - `docs/` - документация проекта

5. WHEN структура изменена, THE Система SHALL обновить все импорты в Python файлах для соответствия новой структуре

### Требование 2: Общие утилиты для ботов

**User Story:** Как разработчик бота, я хочу использовать единый набор инструментов, чтобы не дублировать код между ботами.

#### Критерии приемки

1. THE Система SHALL предоставить общие модули в `shared/`:
   - `shared/actions.py` - действия мыши и клавиатуры
   - `shared/screen.py` - работа со скриншотами
   - `shared/window.py` - управление окнами
   - `shared/vision.py` - базовые CV операции

2. THE Система SHALL предоставить игровые модули в `shared/eve/`:
   - `shared/eve/overview.py` - работа с Overview
   - `shared/eve/hud.py` - работа с HUD
   - `shared/eve/navigation.py` - навигация
   - `shared/eve/combat.py` - боевые действия

3. WHEN бот импортирует модуль, THE Система SHALL предоставить доступ к функциям без дублирования кода

4. THE Система SHALL обеспечить обратную совместимость существующего бота для аномалий

### Требование 3: Кэширование Root Address

**User Story:** Как пользователь бота, я хочу чтобы Sanderling запускался быстро, чтобы не ждать 20 секунд при каждом старте.

#### Критерии приемки

1. WHEN Sanderling находит Root_Address, THE Система SHALL сохранить его в файл кэша

2. WHEN Sanderling запускается, THE Система SHALL загрузить Root_Address из кэша если он существует

3. IF Root_Address из кэша невалиден, THEN THE Система SHALL выполнить полный поиск и обновить кэш

4. THE Система SHALL хранить кэш в `output/data/sanderling_cache.json` с полями:
   - `root_address` - адрес в памяти
   - `process_id` - ID процесса EVE
   - `timestamp` - время последнего обновления
   - `game_version` - версия клиента EVE (если доступна)

5. WHEN процесс EVE перезапущен, THE Система SHALL инвалидировать кэш и выполнить новый поиск

### Требование 4: Оптимизация чтения памяти

**User Story:** Как пользователь бота, я хочу чтобы чтение памяти было быстрым, чтобы бот реагировал оперативно.

#### Критерии приемки

1. WHEN Sanderling читает память с известным Root_Address, THE Система SHALL завершить операцию за время менее 300 миллисекунд

2. THE Система SHALL использовать флаг `--remove-other-dict-entries` для уменьшения размера JSON

3. THE Система SHALL кэшировать распарсенные данные между вызовами если UI_Tree не изменился

4. WHEN чтение памяти занимает более 500 миллисекунд, THE Система SHALL записать предупреждение в лог

5. THE Система SHALL измерять и логировать время каждой операции чтения для мониторинга производительности

### Требование 5: Автоматический запуск и управление процессом

**User Story:** Как пользователь бота, я хочу чтобы Sanderling запускался автоматически, чтобы не управлять им вручную.

#### Критерии приемки

1. WHEN бот запускается, THE Система SHALL автоматически найти процесс EVE Online по имени

2. IF процесс EVE не найден, THEN THE Система SHALL ожидать его появления с проверкой каждые 5 секунд

3. WHEN процесс EVE найден, THE Система SHALL автоматически запустить read-memory-64-bit.exe с корректными параметрами

4. THE Система SHALL запустить Sanderling как фоновый процесс без блокировки основного потока

5. WHEN бот останавливается, THE Система SHALL корректно завершить процесс read-memory-64-bit.exe

6. IF процесс EVE завершается во время работы, THEN THE Система SHALL обнаружить это и остановить Sanderling

### Требование 6: Обработка ошибок и восстановление

**User Story:** Как пользователь бота, я хочу чтобы Sanderling работал стабильно, чтобы бот не падал при ошибках чтения памяти.

#### Критерии приемки

1. IF чтение памяти завершается с ошибкой, THEN THE Система SHALL повторить попытку до 3 раз с задержкой 1 секунда

2. IF все попытки чтения неудачны, THEN THE Система SHALL инвалидировать кэш Root_Address и выполнить полный поиск

3. WHEN происходит ошибка парсинга UI_Tree, THE Система SHALL записать детальную информацию в лог и продолжить работу

4. THE Система SHALL предоставить fallback на Template_Matching если Sanderling недоступен более 30 секунд

5. WHEN Sanderling восстанавливается после ошибки, THE Система SHALL записать событие восстановления в лог

6. THE Система SHALL отслеживать количество ошибок и предупреждать если их более 10 за 5 минут

### Требование 7: Улучшенный парсинг UI Tree

**User Story:** Как разработчик бота, я хочу получать полные данные из UI Tree, чтобы принимать правильные решения.

#### Критерии приемки

1. WHEN Sanderling парсит UI_Tree, THE Система SHALL извлечь данные о залоченных целях:
   - Имя цели
   - Тип цели
   - Дистанция до цели
   - Координаты элемента
   - Статус активной цели

2. WHEN Sanderling парсит UI_Tree, THE Система SHALL извлечь данные Overview:
   - Список всех записей
   - Координаты каждой записи
   - Количество записей

3. WHEN Sanderling парсит UI_Tree, THE Система SHALL извлечь данные модулей корабля:
   - Тип слота (high/mid/low)
   - Статус активности
   - Координаты модуля

4. THE Система SHALL валидировать извлеченные данные на корректность перед возвратом

5. IF данные невалидны или неполны, THEN THE Система SHALL вернуть частичные данные с флагом предупреждения

### Требование 8: Конфигурация и настройки

**User Story:** Как пользователь бота, я хочу настраивать поведение Sanderling, чтобы адаптировать его под свои нужды.

#### Критерии приемки

1. THE Система SHALL предоставить конфигурационный файл `resources/config/sanderling.json` с параметрами:
   - `enabled` - включить/выключить Sanderling
   - `fallback_to_cv` - использовать CV при ошибках
   - `cache_enabled` - использовать кэш Root_Address
   - `read_interval_ms` - интервал чтения памяти
   - `max_retries` - максимум попыток при ошибке
   - `timeout_ms` - таймаут операции чтения

2. WHEN конфигурация изменена, THE Система SHALL применить новые настройки без перезапуска

3. THE Система SHALL валидировать значения конфигурации при загрузке

4. IF конфигурация невалидна, THEN THE Система SHALL использовать значения по умолчанию и записать предупреждение

### Требование 9: Логирование и мониторинг

**User Story:** Как разработчик, я хочу видеть детальные логи работы Sanderling, чтобы диагностировать проблемы.

#### Критерии приемки

1. THE Система SHALL записывать логи Sanderling в `output/logs/sanderling_YYYYMMDD_HHMMSS.log`

2. WHEN происходит важное событие, THE Система SHALL записать в лог:
   - Запуск/остановка сервиса
   - Поиск Root_Address (с временем)
   - Ошибки чтения памяти
   - Восстановление после ошибок
   - Статистику производительности

3. THE Система SHALL записывать метрики производительности каждые 60 секунд:
   - Среднее время чтения
   - Количество успешных чтений
   - Количество ошибок
   - Размер UI_Tree JSON

4. WHEN включен debug режим, THE Система SHALL сохранять снимки UI_Tree в `output/debug/ui_tree_HHMMSS.json`

5. THE Система SHALL ротировать лог файлы старше 7 дней

### Требование 10: Документация и примеры

**User Story:** Как новый разработчик, я хочу иметь документацию и примеры, чтобы быстро начать работу с проектом.

#### Критерии приемки

1. THE Система SHALL предоставить README файлы в каждой основной директории:
   - `core/sanderling/README.md` - документация модуля
   - `core/cv/README.md` - документация CV инструментов
   - `bots/README.md` - общая информация о ботах
   - `shared/README.md` - описание общих утилит

2. THE Система SHALL предоставить примеры использования в `docs/examples/`:
   - `basic_sanderling_usage.py` - базовое использование
   - `hybrid_cv_sanderling.py` - комбинированное использование
   - `custom_bot_template.py` - шаблон нового бота

3. THE Система SHALL обновить главный README.md с новой структурой проекта

4. THE Система SHALL предоставить migration guide в `docs/MIGRATION.md` для перехода на новую структуру

### Требование 11: Тестирование и валидация

**User Story:** Как разработчик, я хочу иметь тесты для Sanderling, чтобы убедиться в корректности работы.

#### Критерии приемки

1. THE Система SHALL предоставить тестовый скрипт `core/sanderling/test_parser.py` для проверки парсера

2. THE Система SHALL предоставить тестовые данные в `core/sanderling/test_data/`:
   - `sample_ui_tree.json` - пример UI tree
   - `sample_targets.json` - пример с целями
   - `sample_overview.json` - пример с Overview

3. WHEN запущен тест парсера, THE Система SHALL проверить корректность извлечения всех типов данных

4. THE Система SHALL предоставить скрипт `scripts/validate_sanderling.py` для проверки работоспособности в реальном времени

5. WHEN запущена валидация, THE Система SHALL выполнить полный цикл: поиск процесса → чтение памяти → парсинг → вывод результатов
