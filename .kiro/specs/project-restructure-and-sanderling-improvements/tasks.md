# План реализации: Реорганизация проекта и улучшение Sanderling

## Обзор

Этот план описывает пошаговую реализацию реорганизации структуры проекта EVE Online бота и улучшения модуля чтения памяти Sanderling. Реализация разделена на логические этапы с инкрементальной интеграцией и тестированием.

## Задачи

- [x] 1. Создание новой структуры директорий
  - Создать все папки согласно новой архитектуре
  - Создать `__init__.py` файлы для Python пакетов
  - Создать `.gitkeep` файлы для пустых директорий
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 2. Реализация скрипта миграции
  - [ ] 2.1 Создать `scripts/migrate_structure.py`
    - Функция создания директорий
    - Функция копирования файлов с сохранением структуры
    - Функция обновления импортов через regex
    - Функция создания backup старой структуры
    - _Requirements: 1.5_
  
  - [ ]* 2.2 Написать unit тесты для скрипта миграции
    - Тест создания директорий
    - Тест копирования файлов
    - Тест обновления импортов
    - _Requirements: 1.5_

- [ ] 3. Реализация модуля кэширования Root Address
  - [x] 3.1 Создать `core/sanderling/cache.py`
    - Класс `RootAddressCache` с методами get/set/invalidate
    - Модель данных `CacheEntry`
    - Функции загрузки/сохранения JSON
    - Валидация записей кэша (проверка timestamp)
    - _Requirements: 3.1, 3.2, 3.4_
  
  - [ ]* 3.2 Написать property тест для кэширования
    - **Property 1: Кэширование Root Address (Round Trip)**
    - **Validates: Requirements 3.1, 3.2, 3.4**
    - Генерировать случайные root address и process ID
    - Сохранять в кэш и загружать обратно
    - Проверять эквивалентность данных
  
  - [ ]* 3.3 Написать property тест для инвалидации при невалидном адресе
    - **Property 2: Инвалидация кэша при невалидном адресе**
    - **Validates: Requirements 3.3**
    - Генерировать невалидные адреса
    - Проверять инвалидацию и полный поиск
  
  - [ ]* 3.4 Написать property тест для инвалидации при перезапуске
    - **Property 3: Инвалидация кэша при перезапуске процесса**
    - **Validates: Requirements 3.5**
    - Симулировать перезапуск процесса (новый PID)
    - Проверять инвалидацию кэша

- [ ] 4. Реализация конфигурации Sanderling
  - [x] 4.1 Создать `core/sanderling/config.py`
    - Dataclass `SanderlingConfig` с параметрами
    - Метод `load()` для загрузки из JSON
    - Метод `save()` для сохранения в JSON
    - Метод `validate()` для валидации значений
    - _Requirements: 8.1, 8.3_
  
  - [x] 4.2 Создать `resources/config/sanderling.json`
    - Файл конфигурации с значениями по умолчанию
    - _Requirements: 8.1_
  
  - [ ]* 4.3 Написать property тест для валидации конфигурации
    - **Property 22: Валидация конфигурации при загрузке**
    - **Validates: Requirements 8.3**
    - Генерировать различные конфигурации
    - Проверять валидацию типов и диапазонов
  
  - [ ]* 4.4 Написать property тест для defaults при невалидной конфигурации
    - **Property 23: Defaults при невалидной конфигурации**
    - **Validates: Requirements 8.4**
    - Генерировать невалидные конфигурации
    - Проверять использование defaults и warning в логе

- [ ] 5. Реализация моделей данных
  - [x] 5.1 Создать `core/sanderling/models.py`
    - Dataclass `GameState`
    - Dataclass `Target`
    - Dataclass `OverviewEntry`
    - Dataclass `Module`
    - Dataclass `ShipState`
    - Dataclass `CacheEntry`
    - _Requirements: 7.1, 7.2, 7.3_

- [ ] 6. Checkpoint - Проверка базовой инфраструктуры
  - Убедиться что все базовые модули созданы
  - Проверить что импорты работают
  - Спросить пользователя если возникли вопросы

- [ ] 7. Реализация парсера UI Tree
  - [x] 7.1 Создать `core/sanderling/parser.py`
    - Класс `UITreeParser`
    - Метод `parse()` для парсинга всего дерева
    - Метод `_parse_targets()` для извлечения целей
    - Метод `_parse_overview()` для извлечения Overview
    - Метод `_parse_modules()` для извлечения модулей
    - Метод `_find_nodes_by_type()` для поиска узлов
    - Метод `_extract_coordinates()` для извлечения координат
    - Валидация извлеченных данных
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  
  - [ ] 7.2 Создать тестовые данные в `core/sanderling/test_data/`
    - `empty_ui_tree.json`
    - `with_targets.json`
    - `with_overview.json`
    - `with_modules.json`
    - `invalid_structure.json`
    - `partial_data.json`
    - _Requirements: 11.2_
  
  - [ ] 7.3 Написать property тест для полноты парсинга

    - **Property 18: Полнота парсинга UI Tree**
    - **Validates: Requirements 7.1, 7.2, 7.3**
    - Генерировать различные UI tree с целями/Overview/модулями
    - Проверять что все данные извлечены
  
  - [ ] 7.4 Написать property тест для валидации данных

    - **Property 19: Валидация извлеченных данных**
    - **Validates: Requirements 7.4**
    - Генерировать UI tree с различными координатами
    - Проверять валидацию (координаты в пределах экрана, имена не пустые)
  
  - [ ]* 7.5 Написать property тест для частичных данных
    - **Property 20: Частичные данные с предупреждением при невалидности**
    - **Validates: Requirements 7.5**
    - Генерировать невалидные UI tree
    - Проверять возврат частичных данных с warnings
  
  - [ ] 7.6 Создать `core/sanderling/test_parser.py`
    - Тесты для каждого типа тестовых данных
    - Проверка корректности извлечения
    - _Requirements: 11.1, 11.3_

- [ ] 8. Реализация Sanderling Service
  - [x] 8.1 Создать `core/sanderling/service.py`
    - Класс `SanderlingService`
    - Метод `start()` для запуска сервиса
    - Метод `stop()` для остановки
    - Метод `get_state()` для получения состояния
    - Метод `_find_eve_process()` для поиска процесса
    - Метод `_read_memory()` для чтения памяти
    - Метод `_handle_error()` для обработки ошибок
    - Интеграция с кэшем и парсером
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3_
  
  - [ ]* 8.2 Написать property тест для автоматического поиска процесса
    - **Property 7: Автоматический поиск процесса EVE**
    - **Validates: Requirements 5.1**
    - Создать mock процесс с именем "exefile.exe"
    - Проверять что он найден автоматически
  
  - [ ]* 8.3 Написать property тест для ожидания процесса
    - **Property 8: Ожидание появления процесса EVE**
    - **Validates: Requirements 5.2**
    - Симулировать отсутствие процесса
    - Проверять периодические проверки каждые 5 секунд
  
  - [ ]* 8.4 Написать property тест для автоматического запуска
    - **Property 9: Автоматический запуск Sanderling при обнаружении процесса**
    - **Validates: Requirements 5.3**
    - Симулировать обнаружение процесса
    - Проверять запуск с корректными параметрами
  
  - [ ] 8.5 Написать property тест для неблокирующего запуска

    - **Property 10: Неблокирующий запуск Sanderling**
    - **Validates: Requirements 5.4**
    - Запустить сервис
    - Проверять что основной поток не блокируется
  
  - [ ]* 8.6 Написать property тест для корректного завершения
    - **Property 11: Корректное завершение процесса при остановке**
    - **Validates: Requirements 5.5**
    - Запустить и остановить сервис
    - Проверять что процесс завершен
  
  - [ ] 8.7 Написать property тест для обнаружения завершения EVE

    - **Property 12: Обнаружение завершения процесса EVE**
    - **Validates: Requirements 5.6**
    - Симулировать завершение процесса EVE
    - Проверять автоматическую остановку Sanderling

- [ ] 9. Реализация обработки ошибок и восстановления
  - [ ] 9.1 Добавить retry механизм в `service.py`
    - Повторные попытки при ошибках (до 3 раз)
    - Задержка 1 секунда между попытками
    - Инвалидация кэша после всех неудач
    - _Requirements: 6.1, 6.2_
  
  - [ ] 9.2 Добавить fallback на CV
    - Переключение на Template Matching при недоступности >30 сек
    - Продолжение попыток восстановления в фоне
    - _Requirements: 6.4_
  
  - [ ]* 9.3 Написать property тест для retry механизма
    - **Property 13: Retry механизм при ошибках чтения**
    - **Validates: Requirements 6.1, 6.2**
    - Симулировать ошибки чтения
    - Проверять количество повторов и инвалидацию
  
  - [ ]* 9.4 Написать property тест для логирования ошибок парсинга
    - **Property 14: Логирование ошибок парсинга с продолжением работы**
    - **Validates: Requirements 6.3**
    - Симулировать ошибки парсинга
    - Проверять логирование и продолжение работы
  
  - [ ]* 9.5 Написать property тест для fallback на CV
    - **Property 15: Fallback на CV при длительной недоступности**
    - **Validates: Requirements 6.4**
    - Симулировать недоступность >30 сек
    - Проверять переключение на CV
  
  - [ ]* 9.6 Написать property тест для логирования восстановления
    - **Property 16: Логирование восстановления**
    - **Validates: Requirements 6.5**
    - Симулировать ошибку и восстановление
    - Проверять запись в лог
  
  - [ ]* 9.7 Написать property тест для мониторинга частоты ошибок
    - **Property 17: Мониторинг частоты ошибок**
    - **Validates: Requirements 6.6**
    - Симулировать 11 ошибок за 5 минут
    - Проверять предупреждение в логе

- [ ] 10. Checkpoint - Проверка core функциональности
  - Убедиться что все core модули работают
  - Запустить тесты парсера
  - Проверить кэширование и конфигурацию
  - Спросить пользователя если возникли вопросы

- [ ] 11. Реализация логирования и мониторинга
  - [ ] 11.1 Добавить логирование в `service.py`
    - Создание лог файлов с форматом имени sanderling_YYYYMMDD_HHMMSS.log
    - Логирование всех важных событий (запуск, остановка, ошибки)
    - Измерение и логирование времени операций
    - Периодическое логирование метрик (каждые 60 сек)
    - Сохранение снимков UI tree в debug режиме
    - Ротация старых лог файлов (>7 дней)
    - _Requirements: 4.4, 4.5, 9.1, 9.2, 9.3, 9.4, 9.5_
  
  - [ ] 11.2 Написать property тест для логирования медленных операций

    - **Property 5: Логирование медленных операций**
    - **Validates: Requirements 4.4**
    - Симулировать операцию >500 мс
    - Проверять warning в логе
  
  - [ ]* 11.3 Написать property тест для измерения времени
    - **Property 6: Измерение времени всех операций**
    - **Validates: Requirements 4.5**
    - Выполнить операцию чтения
    - Проверять что время залогировано
  
  - [ ]* 11.4 Написать property тест для формата лог файлов
    - **Property 24: Логирование событий с корректным форматом имени файла**
    - **Validates: Requirements 9.1, 9.2**
    - Запустить сервис
    - Проверять создание файла с правильным именем
    - Проверять логирование событий
  
  - [ ]* 11.5 Написать property тест для периодических метрик
    - **Property 25: Периодическое логирование метрик**
    - **Validates: Requirements 9.3**
    - Запустить сервис на >60 секунд
    - Проверять наличие метрик в логе
  
  - [ ]* 11.6 Написать property тест для снимков в debug режиме
    - **Property 26: Сохранение снимков UI Tree в debug режиме**
    - **Validates: Requirements 9.4**
    - Включить debug режим
    - Выполнить чтение
    - Проверять сохранение снимка
  
  - [ ]* 11.7 Написать property тест для ротации логов
    - **Property 27: Ротация старых лог файлов**
    - **Validates: Requirements 9.5**
    - Создать старые лог файлы (>7 дней)
    - Запустить систему
    - Проверять удаление старых файлов

- [ ] 12. Реализация оптимизаций
  - [ ] 12.1 Добавить кэширование парсинга в `parser.py`
    - Хранение хеша UI tree
    - Возврат кэшированных данных при совпадении хеша
    - _Requirements: 4.3_
  
  - [ ] 12.2 Добавить использование флага --remove-other-dict-entries
    - Обновить команду запуска read-memory-64-bit.exe
    - _Requirements: 4.2_
  
  - [ ]* 12.3 Написать property тест для кэширования парсинга
    - **Property 4: Кэширование парсинга при неизменном UI Tree**
    - **Validates: Requirements 4.3**
    - Читать одинаковый UI tree дважды
    - Проверять что парсинг не повторяется

- [ ] 13. Создание shared утилит
  - [x] 13.1 Переместить базовые утилиты в `shared/`
    - Скопировать `eve/actions.py` → `shared/actions.py`
    - Скопировать `eve/screen.py` → `shared/screen.py`
    - Скопировать `eve/window.py` → `shared/window.py`
    - Скопировать `eve/vision.py` → `shared/vision.py`
    - Обновить импорты
    - _Requirements: 2.1_
  
  - [x] 13.2 Переместить EVE модули в `shared/eve/`
    - Скопировать `eve/overview.py` → `shared/eve/overview.py`
    - Скопировать `eve/hud.py` → `shared/eve/hud.py`
    - Скопировать `eve/navigation.py` → `shared/eve/navigation.py`
    - Скопировать `eve/combat.py` → `shared/eve/combat.py`
    - Скопировать `eve/telegram_notifier.py` → `shared/eve/telegram_notifier.py`
    - Обновить импорты
    - _Requirements: 2.2_

- [ ] 14. Реализация гибридного Overview модуля
  - [x] 14.1 Создать `core/cv/template_matcher.py`
    - Перенести логику template matching из старого overview.py
    - Класс `TemplateMatcher` с методами поиска шаблонов
    - _Requirements: 2.1_
  
  - [x] 14.2 Обновить `shared/eve/overview.py`
    - Класс `OverviewManager` с поддержкой Sanderling и CV
    - Метод `count_targets()` с fallback
    - Метод `lock_all_targets()` с fallback
    - Метод `get_target_at()` с fallback
    - _Requirements: 2.3, 6.4_

- [ ] 15. Checkpoint - Проверка интеграции
  - Убедиться что все модули интегрированы
  - Проверить работу гибридного режима
  - Запустить все тесты
  - Спросить пользователя если возникли вопросы

- [ ] 16. Миграция бота для аномалий
  - [x] 16.1 Создать `bots/anomaly_farmer/main.py`
    - Скопировать код из `scripts/eve_farm_bot.py`
    - Обновить все импорты на новую структуру
    - Интегрировать с `SanderlingService`
    - Интегрировать с `OverviewManager`
    - _Requirements: 2.4_
  
  - [ ] 16.2 Создать `bots/anomaly_farmer/config.json`
    - Конфигурация бота (интервалы, параметры)
    - _Requirements: 2.4_
  
  - [ ]* 16.3 Написать интеграционный тест для бота
    - Запустить бота с mock данными
    - Проверить что все модули работают вместе
    - _Requirements: 2.4_

- [ ] 17. Создание заготовки бота для абиссов
  - [x] 17.1 Создать `bots/abyss_farmer/main.py`
    - Базовая структура бота
    - Импорты shared модулей
    - Заглушки для основных функций
  
  - [ ] 17.2 Создать `bots/abyss_farmer/config.json`
    - Конфигурация бота

- [ ] 18. Перемещение внешних зависимостей и ресурсов
  - [x] 18.1 Переместить Sanderling
    - `Sanderling/` → `external/Sanderling/`
    - `sanderling-bin/` → `external/sanderling-bin/`
    - Обновить пути в коде
    - _Requirements: 1.3_
  
  - [x] 18.2 Переместить ресурсы
    - `assets/` → `resources/assets/`
    - Создать `resources/config/`
    - Переместить конфигурационные файлы
    - Обновить пути в коде
    - _Requirements: 1.4_
  
  - [x] 18.3 Реорганизовать служебные файлы
    - `logs/` → `output/logs/`
    - `data/` → `output/data/`
    - `inbox/` → `output/debug/`
    - `temp/` → `output/temp/`
    - Обновить пути в коде
    - _Requirements: 1.2_

- [ ] 19. Создание скрипта валидации
  - [ ] 19.1 Создать `scripts/validate_sanderling.py`
    - Поиск процесса EVE
    - Чтение памяти
    - Парсинг UI tree
    - Вывод результатов
    - _Requirements: 11.4, 11.5_
  
  - [ ]* 19.2 Написать property тест для полного цикла валидации
    - **Property 29: Полный цикл валидации**
    - **Validates: Requirements 11.5**
    - Запустить validate_sanderling.py
    - Проверять выполнение всех этапов

- [ ] 20. Создание документации
  - [x] 20.1 Создать README файлы
    - `core/sanderling/README.md` - документация модуля
    - `core/cv/README.md` - документация CV инструментов
    - `bots/README.md` - общая информация о ботах
    - `shared/README.md` - описание общих утилит
    - _Requirements: 10.1_
  
  - [ ] 20.2 Создать примеры в `docs/examples/`
    - `basic_sanderling_usage.py` - базовое использование
    - `hybrid_cv_sanderling.py` - комбинированное использование
    - `custom_bot_template.py` - шаблон нового бота
    - _Requirements: 10.2_
  
  - [x] 20.3 Обновить главный README.md
    - Описание новой структуры
    - Инструкции по установке
    - Примеры использования
    - _Requirements: 10.3_
  
  - [ ] 20.4 Создать `docs/MIGRATION.md`
    - Руководство по миграции со старой структуры
    - Список изменений в импортах
    - Troubleshooting
    - _Requirements: 10.4_
  
  - [ ] 20.5 Создать `docs/API.md`
    - Документация всех публичных API
    - Примеры использования каждого модуля

- [ ] 21. Финальное тестирование и валидация
  - [ ] 21.1 Запустить все unit тесты
    - Проверить что все тесты проходят
    - Исправить найденные баги
  
  - [ ] 21.2 Запустить все property тесты
    - Проверить что все свойства выполняются
    - Исправить найденные баги
  
  - [ ] 21.3 Запустить интеграционные тесты
    - Проверить работу всей системы
    - Проверить бота для аномалий
  
  - [ ] 21.4 Запустить validate_sanderling.py
    - Проверить полный цикл работы
    - Проверить все этапы
  
  - [ ]* 21.5 Написать property тест для корректности тестов парсера
    - **Property 28: Корректность тестов парсера**
    - **Validates: Requirements 11.3**
    - Запустить test_parser.py
    - Проверять что все проверки проходят

- [ ] 22. Checkpoint - Финальная проверка
  - Убедиться что все тесты проходят
  - Убедиться что документация полная
  - Убедиться что миграция работает
  - Спросить пользователя если возникли вопросы

- [ ] 23. Выполнение миграции на реальном проекте
  - [ ] 23.1 Создать backup текущей структуры
    - Скопировать весь проект в backup директорию
  
  - [ ] 23.2 Запустить скрипт миграции
    - Выполнить `python scripts/migrate_structure.py`
    - Проверить что все файлы скопированы
    - Проверить что импорты обновлены
  
  - [ ] 23.3 Проверить работоспособность
    - Запустить бота для аномалий
    - Проверить что Sanderling работает
    - Проверить что логи создаются
    - Проверить что кэш работает
  
  - [ ] 23.4 Удалить старые файлы
    - Удалить старую папку `eve/` (кроме нужных файлов)
    - Удалить старые логи и временные файлы из корня
    - Очистить проект

- [ ] 24. Финальный checkpoint
  - Убедиться что миграция успешна
  - Убедиться что все работает
  - Убедиться что документация актуальна
  - Спросить пользователя о результатах

## Примечания

- Задачи помеченные `*` являются опциональными (тесты) и могут быть пропущены для более быстрого MVP
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Checkpoints обеспечивают инкрементальную валидацию
- Property тесты валидируют универсальные свойства корректности
- Unit тесты валидируют конкретные примеры и edge cases
- Миграция выполняется в конце после полного тестирования новой структуры
