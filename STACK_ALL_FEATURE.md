# Автоматическое складывание филаментов в стопки

## Проблема

При использовании филаментов для входа в Абисс может возникнуть ситуация когда в инвентаре несколько стопок одинаковых филаментов:

```
Calm Exotic Filament (1)
Calm Exotic Filament (2)
Calm Exotic Filament (11)
```

Это создавало проблему при автоматическом использовании филамента.

## Решение

Функция `use_filament()` теперь автоматически складывает все филаменты в стопки перед использованием.

### Что делает функция

1. ✅ Открывает инвентарь (если закрыт)
2. ✅ Активирует фильтр `!FILAMENT!`
3. ✅ **Складывает все филаменты в стопки (Stack All)**
4. ✅ Ждет завершения операции (2 секунды)
5. ✅ Находит филамент
6. ✅ Использует филамент

### Как это работает

```python
from core.sanderling.service import SanderlingService
from eve.inventory import InventoryManager
from config import FILAMENT_NAMES

# Инициализация
sanderling = SanderlingService()
inventory = InventoryManager(sanderling)

# Использовать филамент (все автоматически)
inventory.use_filament(FILAMENT_NAMES['CALM_EXOTIC'])
```

### Отдельное использование Stack All

Если нужно просто сложить предметы в стопки без использования:

```python
# Сложить все предметы в стопки
inventory.stack_all_items()
```

## Технические детали

### Добавленные константы в config.py

```python
CONTEXT_MENU_ACTIONS = {
    # ...
    'STACK_ALL': 'Сложить все предметы в стопки',
    'STACK_ALL_EN': 'Stack All',
}
```

### Новая функция в InventoryManager

```python
def stack_all_items(self) -> bool:
    """
    Сложить все предметы в стопки через контекстное меню.
    
    Делает ПКМ по любому предмету и выбирает "Сложить все предметы в стопки".
    
    Returns:
        True если успешно
    """
```

### Обновленная функция use_filament

Теперь включает шаг складывания в стопки:

```python
def use_filament(self, filament_name: str) -> bool:
    # 1. Открыть инвентарь
    # 2. Активировать фильтр !FILAMENT!
    # 3. Сложить все филаменты в стопки (НОВОЕ!)
    # 4. Использовать филамент
```

## Тестирование

Запустите тестовый скрипт:

```bash
python scripts/test_stack_all.py
```

Скрипт выполнит:
1. Откроет инвентарь
2. Активирует фильтр филаментов
3. Сложит все филаменты в стопки
4. Использует филамент

## Поддержка языков

Функция работает как с русским так и с английским клиентом EVE Online:
- Русский: "Сложить все предметы в стопки"
- English: "Stack All"

## Задержки

- После ПКМ: 1 секунда (ожидание открытия меню)
- После Stack All: 2 секунды (ожидание завершения складывания)
- После складывания: 1 секунда (обновление инвентаря)

Эти задержки обеспечивают надежную работу функции.

## Обратная совместимость

Все существующие скрипты продолжат работать без изменений. Функция `use_filament()` просто стала умнее и теперь автоматически решает проблему с несколькими стопками.

---

**Дата:** 2026-02-06  
**Версия:** v0.5.2
